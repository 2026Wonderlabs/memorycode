<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Personal Memorial</title>
    <style>
      *{margin:0;padding:0;box-sizing:border-box}
      /* Warm, calm palette: soft cream background, muted sepia accents */
      body{font-family:'Georgia','Garamond',serif;color:#2f2a26;background:#fbf6f2;line-height:1.6}
      main{max-width:760px;margin:44px auto;padding:28px;background:#fffdfa;border-radius:10px;box-shadow:0 6px 24px rgba(33,30,27,0.08)}
      .hero{text-align:center;margin-bottom:38px;padding-bottom:28px;border-bottom:1px solid #efe9e2}
      .profile-photo{width:180px;height:180px;border-radius:50%;object-fit:cover;margin:0 auto 18px;border:4px solid #efe6db;display:block}
      h1{font-size:2.4rem;margin-bottom:8px;color:#2b2724;font-weight:500}
      .bio{font-size:1.05rem;color:#61554d;font-style:italic;margin:12px 0 16px;line-height:1.7}
      .section{margin:28px 0}
      .section h2{font-size:1.25rem;margin-bottom:14px;color:#3b332f;font-weight:500;border-bottom:2px solid #efe9e2;padding-bottom:8px}
      .media-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:16px;margin-top:14px}
      .media-item{border-radius:8px;overflow:hidden;background:linear-gradient(180deg,#fffaf7,#fbf8f6);box-shadow:0 1px 0 rgba(0,0,0,0.02);border:1px solid #f0e9e1;position:relative}
      .media-item img,.media-item video{width:100%;height:150px;object-fit:cover;display:block}
      .media-delete-btn{position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:6px;padding:4px 6px;cursor:pointer;font-size:0.9rem}
      .media-delete-btn:hover{background:rgba(0,0,0,0.8)}
      .audio-delete-btn{background:#b89968;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:0.9rem}
      .audio-delete-btn:hover{background:#a87a54}
      .audio-item{margin:12px 0;padding:12px;background:#fbf8f6;border-radius:8px;border:1px solid #efe9e2}
      .audio-name{font-size:0.95rem;color:#50443f;margin-bottom:8px;font-weight:600}
      audio{width:100%;height:34px;margin-bottom:8px}
      .btn{background:#8b6b4a;color:#fff;border:none;padding:10px 18px;border-radius:8px;cursor:pointer;font-size:1rem;font-family:inherit;box-shadow:0 2px 6px rgba(139,107,74,0.12)}
      .btn:hover{background:#6f5943}
      .btn.secondary{background:#d6c6b1;color:#3d2f2a}
      .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(20,18,16,0.45);z-index:1000;align-items:center;justify-content:center;padding:20px}
      .modal.show{display:flex}
      .modal-content{background:#fffdfa;padding:26px;border-radius:10px;max-width:640px;width:100%;box-shadow:0 8px 30px rgba(33,30,27,0.08)}
      .modal-content h3{margin-bottom:18px;font-size:1.15rem;font-weight:500;color:#2b2724}
      .form-group{margin:14px 0}
      .form-group label{display:block;margin-bottom:6px;font-weight:600;color:#3b332f}
      .form-group input,.form-group textarea{width:100%;padding:10px 12px;border:1px solid #eee;border-radius:6px;font-family:inherit;font-size:1rem;background:#fffefc}
      .form-group textarea{resize:vertical;min-height:100px}
      .modal-buttons{display:flex;gap:10px;margin-top:18px}
      .modal-buttons button{flex:1}
      .upload-preview{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
      .upload-preview .preview-item{width:120px;border-radius:8px;border:1px solid #efe9e2;background:#fffaf7;padding:6px;position:relative}
      .upload-preview .preview-item img{width:100%;height:80px;object-fit:cover;border-radius:6px}
      .preview-name{font-size:0.85rem;color:#3b332f;margin-top:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
      .preview-remove{position:absolute;right:6px;top:6px;background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;cursor:pointer}
      #createSection{padding:22px;text-align:center}
      #createSection h2{font-size:1.6rem;margin-bottom:14px}
      #createForm{max-width:520px;margin:0 auto;text-align:left}
      .small{font-size:0.92rem;color:#7e6f66}
      @keyframes flicker { 0%,100%{opacity:0.8} 50%{opacity:1} }
      .candle{text-align:center;padding:20px;margin:20px 0}
      .candle-flame{font-size:2.5rem;display:inline-block;animation:flicker 1.5s infinite}
      .story-section{background:#fffaf7;padding:16px;border-radius:8px;margin:16px 0;border-left:4px solid #8b6b4a}
      .quote-section{background:#efe9e2;padding:16px;border-radius:8px;margin:16px 0;text-align:center;font-style:italic;color:#50443f}
      .messages-section{margin:28px 0}
      .messages-form{background:#fbf8f6;padding:14px;border-radius:8px;margin-bottom:16px}
      .messages-form input, .messages-form textarea{width:100%;padding:10px;margin:8px 0;border:1px solid #eee;border-radius:6px;font-family:inherit}
      .messages-list{background:#fffaf7;border-radius:8px;padding:12px}
      .message-item{background:#fff;padding:12px;margin:8px 0;border-radius:6px;border-left:3px solid #d6c6b1}
      .message-author{font-weight:600;color:#3b332f;font-size:0.95rem}
      .message-date{font-size:0.85rem;color:#8b8178}
      .message-text{color:#50443f;margin-top:6px;line-height:1.5}
      @media (max-width:600px){
        .media-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}
      }
    </style>
  </head>
  <body>
    <div style="position:fixed;right:18px;top:18px;z-index:1100">
      <button id="globalAuthBtn" class="btn secondary" onclick="showLoginModal()">Login</button>
    </div>
    <main id="profileWrap" style="display:none">
      <div class="hero">
        <img id="profilePhoto" class="profile-photo" src="" alt="Profile photo" style="display:none">
        <h1 id="profileName">Remembering</h1>
        <p id="profileBio" class="bio"></p>
        <button class="btn" onclick="showEditModal()">Edit Profile</button>
        <button id="heroAuthBtn" class="btn secondary" style="margin-left:10px" onclick="showLoginModal()">Login</button>
        <button class="btn" style="background:#b89968;margin-left:10px" onclick="showUploadModal()">Upload Media</button>
      </div>

      <div class="section" id="photosSection" style="display:none">
        <h2>Photos</h2>
        <div id="photosContainer" class="media-grid"></div>
      </div>

      <div class="section" id="videosSection" style="display:none">
        <h2>Videos</h2>
        <div id="videosContainer" class="media-grid"></div>
      </div>

      <div class="section" id="audiosSection" style="display:none">
        <h2>Audio Messages & Voices</h2>
        <div id="audiosContainer"></div>
      </div>

      <div class="candle">
        <div class="candle-flame">üïØÔ∏è</div>
        <p style="font-size:0.9rem;color:#8b8178;margin-top:8px">Light a candle to honour their memory</p>
      </div>

      <div class="section" id="storySection" style="display:none">
        <h2>Life Story</h2>
        <div id="storyContainer" class="story-section"></div>
      </div>

      <div class="section" id="quoteSection" style="display:none">
        <h2>Favourite Quote</h2>
        <div id="quoteContainer" class="quote-section"></div>
      </div>

      <div class="section" id="messagesSection" style="display:none;margin-top:40px">
        <h2>Tributes & Messages</h2>
        <div class="messages-form">
          <form id="messageForm">
            <input id="messageName" type="text" placeholder="Your name (optional)">
            <textarea id="messageText" placeholder="Share a memory, message, or tribute..." rows="3" required></textarea>
            <button type="submit" class="btn" style="width:100%;margin-top:8px">Post Message</button>
            <div id="messageStatus" class="small" style="margin-top:8px;text-align:center;color:#8b6b4a"></div>
          </form>
        </div>
        <div id="messagesList" class="messages-list"></div>
      </div>

      <div id="profileQrSection" style="text-align:center;margin-top:40px;padding-top:20px;border-top:1px solid #e0ddd9">
        <p class="small">Share this memorial with a QR code:</p>
        <img id="profileQr" src="" alt="QR code" style="width:200px;margin-top:12px">
      </div>
    </main>

    <main id="createSection">
      <div style="text-align:center;margin-bottom:40px">
        <h2>Create a Memorial</h2>
        <p class="small">Honor someone special by creating a personal memorial page.</p>
      </div>
      <form id="createForm">
        <div class="form-group">
          <label>Their name</label>
          <input name="name" type="text" placeholder="e.g., John Smith" required>
        </div>
        <div class="form-group">
          <label>Profile id (optional, will auto-generate from name)</label>
          <input name="id" type="text" placeholder="e.g., john-1960-2024">
        </div>
        <div class="form-group">
          <label>Admin passcode (to add/edit content)</label>
          <input name="passcode" type="password" placeholder="Choose a strong passcode" required>
        </div>
        <div class="form-group">
          <label>Biography or story (optional)</label>
          <textarea name="bio" placeholder="Share their story, memories, or words..."></textarea>
        </div>
        <button type="submit" class="btn" style="width:100%">Create Memorial</button>
      </form>
      <div id="createResult" class="small" style="margin-top:15px;text-align:center"></div>
    </main>

    <div id="editModal" class="modal">
      <div class="modal-content">
        <h3>Edit Memorial</h3>
        <form id="editForm">
          <div class="form-group">
            <label>Name</label>
            <input id="editName" type="text" placeholder="Name">
          </div>
          <div class="form-group">
            <label>Biography</label>
            <textarea id="editBio" placeholder="Biography"></textarea>
          </div>
          <div class="form-group">
            <label>Life Story or Timeline (optional)</label>
            <textarea id="editStory" placeholder="Major life events, dates, achievements, memories..."></textarea>
          </div>
          <div class="form-group">
            <label>Favourite Quote or Saying (optional)</label>
            <input id="editQuote" type="text" placeholder="A quote they lived by...">
          </div>
          <div class="form-group">
            <label>Profile photo (select image)</label>
            <input id="editPhotoFile" type="file" accept="image/*">
            <div id="editPhotoPreview" style="margin-top:8px"></div>
          </div>
          <div class="form-group">
            <label>Admin passcode</label>
            <input id="editPass" type="password" placeholder="Passcode">
          </div>
          <div class="modal-buttons">
            <button type="submit" class="btn">Save</button>
            <button type="button" class="btn" style="background:#999" onclick="closeEditModal()">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <div id="uploadModal" class="modal">
      <div class="modal-content">
        <h3>Upload Photos, Videos & Audio</h3>
        <form id="uploadForm">
          <div class="form-group">
            <label>Admin passcode</label>
            <input id="uploadPass" type="password" placeholder="Enter passcode" required>
          </div>
          <div class="form-group">
            <label>Photos (JPG, PNG, WebP)</label>
            <input type="file" accept="image/*" multiple id="uploadPhotos">
          </div>
          <div class="form-group">
            <label>Videos (MP4, WebM, MOV)</label>
            <input type="file" accept="video/*" multiple id="uploadVideos">
          </div>
          <div class="form-group">
            <label>Audio (MP3, WAV, OGG)</label>
            <input type="file" accept="audio/*" multiple id="uploadAudios">
          </div>
          <div id="uploadPreview" class="upload-preview" aria-live="polite"></div>
          <div class="modal-buttons">
            <button type="submit" class="btn">Upload Files</button>
            <button type="button" class="btn" style="background:#999" onclick="closeUploadModal()">Cancel</button>
          </div>
          <div id="uploadStatus" class="small" style="margin-top:10px;text-align:center"></div>
        </form>
      </div>
    </div>

    <div id="loginModal" class="modal">
      <div class="modal-content">
        <h3>Login to Edit / Upload</h3>
        <form id="loginForm">
          <div class="form-group">
            <label>Profile id</label>
            <input id="loginId" type="text" placeholder="profile-id (or leave blank to use current)">
          </div>
          <div class="form-group">
            <label>Passcode</label>
            <input id="loginPass" type="password" placeholder="Enter passcode" required>
          </div>
          <div class="modal-buttons">
            <button type="submit" class="btn">Login</button>
            <button type="button" class="btn" style="background:#999" onclick="closeLoginModal()">Cancel</button>
          </div>
          <div id="loginStatus" class="small" style="margin-top:10px;text-align:center"></div>
        </form>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(location.search);
      let id = params.get('id');
      let currentProfile = null;

      function slugify(text) {
        return (text || '').toString().toLowerCase().trim()
          .replace(/[^a-z0-9\s-]/g, '')
          .replace(/\s+/g, '-')
          .replace(/-+/g, '-');
      }

      function showEditModal() {
        document.getElementById('editModal').classList.add('show');
        if (currentProfile) {
          document.getElementById('editName').value = currentProfile.name;
          document.getElementById('editBio').value = currentProfile.bio;
          document.getElementById('editStory').value = currentProfile.story || '';
          document.getElementById('editQuote').value = currentProfile.quote || '';
        }
      }

      function closeEditModal() {
        document.getElementById('editModal').classList.remove('show');
      }

      function showUploadModal() {
        document.getElementById('uploadModal').classList.add('show');
        document.getElementById('uploadStatus').textContent = '';
      }

      function closeUploadModal() {
        document.getElementById('uploadModal').classList.remove('show');
      }

      function showLoginModal(){
        document.getElementById('loginStatus').textContent = '';
        document.getElementById('loginId').value = id || '';
        document.getElementById('loginPass').value = '';
        document.getElementById('loginModal').classList.add('show');
      }

      function closeLoginModal(){
        document.getElementById('loginModal').classList.remove('show');
      }

      async function loadProfile() {
        try {
          const res = await fetch(`/api/profile?id=${encodeURIComponent(id)}`);
          if (!res.ok) {
            document.getElementById('createSection').style.display = 'block';
            document.getElementById('profileWrap').style.display = 'none';
            return;
          }
          const j = await res.json();
          currentProfile = j;
          document.getElementById('profileName').textContent = j.name || 'Remembering';
          document.getElementById('profileBio').textContent = j.bio || '';
          if (j.photo) {
            document.getElementById('profilePhoto').src = j.photo;
            document.getElementById('profilePhoto').style.display = 'block';
          }
          document.getElementById('createSection').style.display = 'none';
          document.getElementById('profileWrap').style.display = 'block';

          // Render photos, videos, and audios
          renderPhotos(j.photos || []);
          renderVideos(j.videos || []);

          // Display story
          if (j.story) {
            document.getElementById('storyContainer').textContent = j.story;
            document.getElementById('storySection').style.display = 'block';
          } else {
            document.getElementById('storySection').style.display = 'none';
          }

          // Display quote
          if (j.quote) {
            document.getElementById('quoteContainer').textContent = `"${j.quote}"`;
            document.getElementById('quoteSection').style.display = 'block';
          } else {
            document.getElementById('quoteSection').style.display = 'none';
          }

          // Load audios from auto-discovery
          try {
            const a = await fetch(`/api/audios?id=${encodeURIComponent(id)}`);
            if (a.ok) {
              const aj = await a.json();
              renderAudios(aj.audios || []);
            }
          } catch (e) { console.warn('Audios fetch failed', e); }

          // Load messages
          try {
            const m = await fetch(`/api/messages?id=${encodeURIComponent(id)}`);
            if (m.ok) {
              const mj = await m.json();
              renderMessages(mj.messages || []);
            }
          } catch (e) { console.warn('Messages fetch failed', e); }

          // Load QR
          try {
            const q = await fetch(`/api/profile-qr?id=${encodeURIComponent(id)}`);
            if (q.ok) {
              const qj = await q.json();
              document.getElementById('profileQr').src = qj.dataUrl;
            }
          } catch (e) { console.warn('QR fetch failed', e); }
        } catch (e) {
          console.error(e);
        }
      }

      function renderPhotos(photos) {
        const container = document.getElementById('photosContainer');
        container.innerHTML = '';
        if (photos.length === 0) {
          document.getElementById('photosSection').style.display = 'none';
          return;
        }
        document.getElementById('photosSection').style.display = 'block';
        photos.forEach(p => {
          const div = document.createElement('div');
          div.className = 'media-item';
          const img = document.createElement('img');
          img.src = p.url;
          img.alt = p.name;
          div.appendChild(img);
          const delBtn = document.createElement('button');
          delBtn.className = 'media-delete-btn';
          delBtn.type = 'button';
          delBtn.textContent = 'üóëÔ∏è';
          delBtn.title = 'Delete photo';
          delBtn.addEventListener('click', () => deleteMediaFile('photos', p.name));
          div.appendChild(delBtn);
          container.appendChild(div);
        });
      }

      function renderVideos(videos) {
        const container = document.getElementById('videosContainer');
        container.innerHTML = '';
        if (videos.length === 0) {
          document.getElementById('videosSection').style.display = 'none';
          return;
        }
        document.getElementById('videosSection').style.display = 'block';
        videos.forEach(v => {
          const div = document.createElement('div');
          div.className = 'media-item';
          const video = document.createElement('video');
          video.controls = true;
          video.src = v.url;
          video.style.width = '100%';
          video.style.height = '150px';
          video.style.objectFit = 'cover';
          div.appendChild(video);
          const delBtn = document.createElement('button');
          delBtn.className = 'media-delete-btn';
          delBtn.type = 'button';
          delBtn.textContent = 'üóëÔ∏è';
          delBtn.title = 'Delete video';
          delBtn.addEventListener('click', () => deleteMediaFile('videos', v.name));
          div.appendChild(delBtn);
          container.appendChild(div);
        });
      }

      function renderAudios(audios) {
        const container = document.getElementById('audiosContainer');
        container.innerHTML = '';
        if (audios.length === 0) {
          document.getElementById('audiosSection').style.display = 'none';
          return;
        }
        document.getElementById('audiosSection').style.display = 'block';
        audios.forEach(a => {
          const div = document.createElement('div');
          div.className = 'audio-item';
          const name = document.createElement('div');
          name.className = 'audio-name';
          name.textContent = a.name;
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = a.url;
          const delBtn = document.createElement('button');
          delBtn.className = 'audio-delete-btn';
          delBtn.type = 'button';
          delBtn.textContent = 'üóëÔ∏è Remove';
          delBtn.style.marginLeft = '10px';
          delBtn.addEventListener('click', () => deleteMediaFile('audios', a.name));
          div.appendChild(name);
          div.appendChild(audio);
          div.appendChild(delBtn);
          container.appendChild(div);
        });
      }

      function renderMessages(messages) {
        const container = document.getElementById('messagesList');
        container.innerHTML = '';
        if (messages.length === 0) {
          document.getElementById('messagesSection').style.display = 'none';
          return;
        }
        document.getElementById('messagesSection').style.display = 'block';
        messages.forEach(m => {
          const div = document.createElement('div');
          div.className = 'message-item';
          const author = document.createElement('div');
          author.className = 'message-author';
          author.textContent = m.name || 'Anonymous';
          const dateStr = new Date(m.ts).toLocaleDateString();
          const date = document.createElement('div');
          date.className = 'message-date';
          date.textContent = dateStr;
          const text = document.createElement('div');
          text.className = 'message-text';
          text.textContent = m.text;
          div.appendChild(author);
          div.appendChild(date);
          div.appendChild(text);
          container.appendChild(div);
        });
      }

      document.getElementById('editForm').addEventListener('submit', async ev => {
        ev.preventDefault();
        const nameVal = document.getElementById('editName').value;
        const bioVal = document.getElementById('editBio').value;
        const storyVal = document.getElementById('editStory').value;
        const quoteVal = document.getElementById('editQuote').value;
        const passVal = document.getElementById('editPass').value;

        // if a new photo file was selected, upload it first via /api/upload
        const photoFileInput = document.getElementById('editPhotoFile');
        let newPhotoUrl = undefined;
        if (photoFileInput && photoFileInput.files && photoFileInput.files.length > 0) {
          const fd = new FormData();
          fd.append('passcode', passVal);
          fd.append('photos', photoFileInput.files[0]);
          const up = await fetch(`/api/upload?id=${encodeURIComponent(id)}`, { method: 'POST', body: fd });
          if (!up.ok) {
            alert('Failed to upload photo: ' + await up.text());
            return;
          }
          // fetch profile to discover uploaded photo URL (pick newest photo)
          const p = await fetch(`/api/profile?id=${encodeURIComponent(id)}`);
          if (p.ok) {
            const pj = await p.json();
            const photos = pj.photos || [];
            if (photos.length > 0) {
              photos.sort((a,b) => b.ts - a.ts);
              newPhotoUrl = photos[0].url;
            }
          }
        }

        const payload = { name: nameVal, bio: bioVal, passcode: passVal, story: storyVal, quote: quoteVal };
        if (newPhotoUrl) payload.newPhoto = newPhotoUrl;

        const res = await fetch(`/api/edit-profile?id=${encodeURIComponent(id)}`, { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify(payload) });
        if (res.ok) {
          closeEditModal();
          loadProfile();
        } else {
          alert('Failed to save: ' + await res.text());
        }
      });

      document.getElementById('uploadForm').addEventListener('submit', async ev => {
        ev.preventDefault();
        const passcode = document.getElementById('uploadPass').value;
        const photos = document.getElementById('uploadPhotos').files;
        const videos = document.getElementById('uploadVideos').files;
        const audios = document.getElementById('uploadAudios').files;

        if (photos.length === 0 && videos.length === 0 && audios.length === 0) {
          document.getElementById('uploadStatus').textContent = 'Please select at least one file';
          return;
        }

        const fd = new FormData();
        fd.append('passcode', passcode);
        for (const f of photos) fd.append('photos', f);
        for (const f of videos) fd.append('videos', f);
        for (const f of audios) fd.append('audios', f);

        document.getElementById('uploadStatus').textContent = 'Uploading...';
        const res = await fetch(`/api/upload?id=${encodeURIComponent(id)}`, { method: 'POST', body: fd });
        if (res.ok) {
          document.getElementById('uploadStatus').textContent = 'Uploaded successfully!';
          setTimeout(() => {
            closeUploadModal();
            loadProfile();
          }, 1000);
        } else {
          document.getElementById('uploadStatus').textContent = 'Error: ' + await res.text();
        }
      });

        document.getElementById('loginForm').addEventListener('submit', async ev => {
          ev.preventDefault();
          const pid = document.getElementById('loginId').value.trim() || id;
          const pass = document.getElementById('loginPass').value;
          if (!pid) { document.getElementById('loginStatus').textContent = 'Missing profile id'; return; }
          const res = await fetch('/api/login', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ id: pid, passcode: pass }) });
          if (res.ok) {
            // store in sessionStorage for this profile
            sessionStorage.setItem('memorial_pass_' + pid, pass);
            document.getElementById('loginStatus').textContent = 'Logged in';
            updateAuthUI();
            setTimeout(() => { closeLoginModal(); if (!id) { id = pid; location.search = '?id=' + encodeURIComponent(pid); } else loadProfile(); }, 500);
          } else {
            document.getElementById('loginStatus').textContent = 'Login failed: ' + await res.text();
          }
        });

        // Prefill passcodes from session when opening upload/edit
        const origShowUploadModal = showUploadModal;
        showUploadModal = function(){
          const pass = sessionStorage.getItem('memorial_pass_' + (id || '')) || '';
          document.getElementById('uploadPass').value = pass;
          origShowUploadModal();
        }

        const origShowEditModal = showEditModal;
        showEditModal = function(){
          const pass = sessionStorage.getItem('memorial_pass_' + (id || '')) || '';
          document.getElementById('editPass').value = pass;
          origShowEditModal();
        }

      document.getElementById('createForm').addEventListener('submit', async ev => {
        ev.preventDefault();
        const f = ev.target;
        let newId = f.id.value.trim();
        if (!newId) { newId = slugify(f.name.value) || ('memorial' + Date.now()); }
        const payload = { id: newId, name: f.name.value.trim(), passcode: f.passcode.value, bio: f.bio.value };
        const res = await fetch('/api/create-profile', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify(payload) });
        if (res.status === 201) {
          location.search = '?id=' + encodeURIComponent(payload.id);
        } else {
          document.getElementById('createResult').textContent = 'Error: ' + await res.text();
        }
      });

      if (id) {
        loadProfile();
      } else {
        autoLoadProfile();
        document.getElementById('createSection').style.display = 'block';
        document.getElementById('profileWrap').style.display = 'none';
      }

      // Update auth UI (login -> logout) and wire upload previews
      function updateAuthUI(){
        const pid = id || '';
        const pass = sessionStorage.getItem('memorial_pass_' + pid) || '';
        const logged = !!pass;
        const globalBtn = document.getElementById('globalAuthBtn');
        const heroBtn = document.getElementById('heroAuthBtn');
        if (globalBtn){
          globalBtn.textContent = logged ? 'Logout' : 'Login';
          globalBtn.onclick = logged ? logout : showLoginModal;
        }
        if (heroBtn){
          heroBtn.textContent = logged ? 'Logout' : 'Login';
          heroBtn.onclick = logged ? logout : showLoginModal;
        }
      }

      function logout(){
        const pid = id || '';
        sessionStorage.removeItem('memorial_pass_' + pid);
        updateAuthUI();
        // Go back to create page
        location.search = '';
      }
      
      // On page load: if not already from URL, check sessionStorage for last logged-in profile and auto-load
      function autoLoadProfile(){
        if (id) return; // Already have id from URL
        // Check all sessionStorage keys for memorial_pass_* entries
        for (let i = 0; i < sessionStorage.length; i++) {
          const k = sessionStorage.key(i);
          if (k && k.startsWith('memorial_pass_')) {
            const pid = k.replace('memorial_pass_', '');
            // Try to load this profile
            fetch(`/api/profile?id=${encodeURIComponent(pid)}`)
              .then(r => r.ok ? null : Promise.reject())
              .then(() => {
                id = pid;
                location.search = `?id=${encodeURIComponent(pid)}`;
              })
              .catch(() => {
                // Profile doesn't exist or error, clear it
                sessionStorage.removeItem(k);
              });
            break; // Try only the first one found
          }
        }
      }

      // Upload preview helpers
      function mkPreviewItem(file, type, inputId){
        const div = document.createElement('div');
        div.className = 'preview-item';
        const btn = document.createElement('button');
        btn.className = 'preview-remove';
        btn.type = 'button';
        btn.textContent = '√ó';
        btn.title = 'Remove';
        btn.addEventListener('click', () => removeFileFromInput(inputId, file));
        div.appendChild(btn);
        if (type === 'image' && file.type.startsWith('image/')){
          const img = document.createElement('img');
          img.src = URL.createObjectURL(file);
          div.appendChild(img);
        } else {
          const img = document.createElement('img');
          // simple placeholder icons for audio/video/other
          if (type === 'audio') img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="80"><rect width="100%" height="100%" fill="%23fffaf7" stroke="%23efe9e2"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%233b332f" font-size="12">Audio</text></svg>';
          else if (type === 'video') img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="80"><rect width="100%" height="100%" fill="%23fffaf7" stroke="%23efe9e2"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%233b332f" font-size="12">Video</text></svg>';
          else img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="80"><rect width="100%" height="100%" fill="%23fffaf7" stroke="%23efe9e2"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%233b332f" font-size="12">File</text></svg>';
          div.appendChild(img);
        }
        const n = document.createElement('div');
        n.className = 'preview-name';
        n.textContent = file.name;
        div.appendChild(n);
        return div;
      }

      function removeFileFromInput(inputId, fileToRemove){
        const input = document.getElementById(inputId);
        if (!input) return;
        const dt = new DataTransfer();
        Array.from(input.files).forEach(f => {
          if (!(f.name === fileToRemove.name && f.size === fileToRemove.size && f.lastModified === fileToRemove.lastModified)){
            dt.items.add(f);
          }
        });
        input.files = dt.files;
        renderUploadPreviews();
      }

      function renderUploadPreviews(){
        const preview = document.getElementById('uploadPreview');
        preview.innerHTML = '';
        const imgs = document.getElementById('uploadPhotos')?.files || [];
        const vids = document.getElementById('uploadVideos')?.files || [];
        const auds = document.getElementById('uploadAudios')?.files || [];
        Array.from(imgs).forEach(f => preview.appendChild(mkPreviewItem(f, 'image', 'uploadPhotos')));
        Array.from(vids).forEach(f => preview.appendChild(mkPreviewItem(f, 'video', 'uploadVideos')));
        Array.from(auds).forEach(f => preview.appendChild(mkPreviewItem(f, 'audio', 'uploadAudios')));
      }

      ['uploadPhotos','uploadVideos','uploadAudios'].forEach(idc => {
        const el = document.getElementById(idc);
        if (el) el.addEventListener('change', renderUploadPreviews);
      });

      // Delete uploaded media file
      async function deleteMediaFile(type, filename){
        if (!confirm(`Delete this ${type.slice(0,-1)}?`)) return;
        const pass = sessionStorage.getItem('memorial_pass_' + (id || '')) || '';
        if (!pass) { alert('You need to be logged in to delete'); return; }
        const res = await fetch(`/api/delete-file?id=${encodeURIComponent(id)}`, {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ type, filename, passcode: pass })
        });
        if (res.ok) {
          loadProfile(); // Refresh to show deletion
        } else {
          alert('Delete failed: ' + await res.text());
        }
      }

      // Message form submit
      const messageForm = document.getElementById('messageForm');
      if (messageForm) {
        messageForm.addEventListener('submit', async ev => {
          ev.preventDefault();
          const name = document.getElementById('messageName').value.trim() || 'Anonymous';
          const message = document.getElementById('messageText').value.trim();
          if (!message) { alert('Please enter a message'); return; }
          const res = await fetch(`/api/add-message?id=${encodeURIComponent(id)}`, {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ name, message })
          });
          if (res.ok) {
            document.getElementById('messageName').value = '';
            document.getElementById('messageText').value = '';
            document.getElementById('messageStatus').textContent = 'Message posted!';
            setTimeout(() => { loadProfile(); }, 500);
          } else {
            document.getElementById('messageStatus').textContent = 'Failed to post: ' + await res.text();
          }
        });
      }

      // initial UI update
      updateAuthUI();
    </script>
  </body>
</html>
